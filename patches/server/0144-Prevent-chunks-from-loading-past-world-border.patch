From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: SoftikLord <dimap9986@gmail.com>
Date: Tue, 31 Jan 2023 15:52:24 +0500
Subject: [PATCH] Prevent-chunks-from-loading-past-world-border


diff --git a/src/main/java/com/github/ruviolence/reaper/ReaperConfig.java b/src/main/java/com/github/ruviolence/reaper/ReaperConfig.java
index b9e0ec8066abab58c38886b6a1f9434740537a6e..5baf12b83d9a4fbf6563401935e01381c9d9e78d 100644
--- a/src/main/java/com/github/ruviolence/reaper/ReaperConfig.java
+++ b/src/main/java/com/github/ruviolence/reaper/ReaperConfig.java
@@ -270,6 +270,11 @@ public class ReaperConfig {
         pingPeriod = MathHelper.clamp(getInt("ping-period", 15), 1, 30) * 1000L;
     }
 
+    public static Boolean preventChunksWorldBorder = true;
+    private static void preventChunksWorldBorder() {
+        preventChunksWorldBorder = getBoolean("settings.prevent-chunks-generating-past-worldborder-lag-exploit", true);
+    }
+
     public static boolean entityTrackerCheckY;
     private static void entityTrackerCheckY() {
         entityTrackerCheckY = getBoolean("entity-tracker-check-y", false);
diff --git a/src/main/java/net/minecraft/server/ChunkProviderServer.java b/src/main/java/net/minecraft/server/ChunkProviderServer.java
index 111c421fd7c343719001b6b7c50093a00e4851b7..f7d7cb3a6d8379e716e9b88f7546544c92ba027d 100644
--- a/src/main/java/net/minecraft/server/ChunkProviderServer.java
+++ b/src/main/java/net/minecraft/server/ChunkProviderServer.java
@@ -1,6 +1,7 @@
 package net.minecraft.server;
 
 import com.destroystokyo.paper.PaperConfig;
+import com.github.ruviolence.reaper.ReaperConfig;
 import com.google.common.collect.Lists;
 import com.google.common.collect.Sets;
 import it.unimi.dsi.fastutil.longs.Long2ObjectMap;
@@ -131,8 +132,10 @@ public class ChunkProviderServer implements IChunkProvider {
             chunk = this.loadChunk(i, j);
             if (chunk != null) {
                 this.chunks.put(ChunkCoordIntPair.a(i, j), chunk);
-                chunk.addEntities();
-                chunk.loadNearby(this, this.chunkGenerator, false); // CraftBukkit
+                if(!ReaperConfig.preventChunksWorldBorder || (chunk.locX <= 1875000 && chunk.locZ <= 1875000 && chunk.locX >= -1875000 && chunk.locZ >= -1875000)){ // Papaya - Patch retarded lag exploit at world border
+                    chunk.loadNearby(this, this.chunkGenerator, true); // CraftBukkit
+                    chunk.addEntities();
+                }
             }
         }
 
@@ -209,8 +212,10 @@ public class ChunkProviderServer implements IChunkProvider {
             }
 
             this.chunks.put(k, chunk);
-            chunk.addEntities();
-            chunk.loadNearby(this, this.chunkGenerator, true); // CraftBukkit
+            if(!ReaperConfig.preventChunksWorldBorder || (chunk.locX <= 1875000 && chunk.locZ <= 1875000 && chunk.locX >= -1875000 && chunk.locZ >= -1875000)){ // Papaya - Patch retarded lag exploit at world border
+                chunk.loadNearby(this, this.chunkGenerator, true); // CraftBukkit
+                chunk.addEntities();
+            }
             world.timings.syncChunkLoadTimer.stopTiming(); // Spigot
         }
 
diff --git a/src/main/java/net/minecraft/server/PlayerChunk.java b/src/main/java/net/minecraft/server/PlayerChunk.java
index 54fd5f22e564ef3093e74a0b62fe1072e6c9340a..c1858f854578a01a73914f44b59ae1bd7adb7d40 100644
--- a/src/main/java/net/minecraft/server/PlayerChunk.java
+++ b/src/main/java/net/minecraft/server/PlayerChunk.java
@@ -1,5 +1,6 @@
 package net.minecraft.server;
 
+import com.github.ruviolence.reaper.ReaperConfig;
 import com.google.common.base.Predicate;
 import com.google.common.collect.Iterables;
 import com.google.common.collect.Lists;
@@ -48,12 +49,14 @@ public class PlayerChunk {
     public PlayerChunk(PlayerChunkMap playerchunkmap, int i, int j) {
         this.playerChunkMap = playerchunkmap;
         this.location = new ChunkCoordIntPair(i, j);
-        // CraftBukkit start
-        loadInProgress = true;
-        this.chunk = playerchunkmap.getWorld().getChunkProviderServer().getChunkAt(i, j, loadedRunnable, false);
-        this.chunkExists = this.chunk != null || ChunkIOExecutor.hasQueuedChunkLoad(playerChunkMap.getWorld(), i, j); // Paper
-        markChunkUsed(); // Paper - delay chunk unloads
-        // CraftBukkit end
+        if(!ReaperConfig.preventChunksWorldBorder || (location.x <= 1875000 && location.z <= 1875000 && location.x >= -1875000 && location.z >= -1875000)) { // Papaya - Patch retarded lag exploit at world border
+            // CraftBukkit start
+            loadInProgress = true;
+            this.chunk = playerchunkmap.getWorld().getChunkProviderServer().getChunkAt(i, j, loadedRunnable, false);
+            this.chunkExists = this.chunk != null || ChunkIOExecutor.hasQueuedChunkLoad(playerChunkMap.getWorld(), i, j); // Paper
+            markChunkUsed(); // Paper - delay chunk unloads
+            // CraftBukkit end
+        }
     }
 
     public ChunkCoordIntPair a() {
diff --git a/src/main/java/org/bukkit/craftbukkit/chunkio/ChunkIOProvider.java b/src/main/java/org/bukkit/craftbukkit/chunkio/ChunkIOProvider.java
index cdf3b614c78fe2684e586263aa9c1688e146f8d7..85fbe442193bfaac88c5ad46777d226f42459aa9 100644
--- a/src/main/java/org/bukkit/craftbukkit/chunkio/ChunkIOProvider.java
+++ b/src/main/java/org/bukkit/craftbukkit/chunkio/ChunkIOProvider.java
@@ -3,6 +3,7 @@ package org.bukkit.craftbukkit.chunkio;
 import java.io.IOException;
 
 import co.aikar.timings.Timing;
+import com.github.ruviolence.reaper.ReaperConfig;
 import net.minecraft.server.Chunk;
 import net.minecraft.server.ChunkCoordIntPair;
 import net.minecraft.server.ChunkRegionLoader;
@@ -56,7 +57,9 @@ class ChunkIOProvider implements AsynchronousExecutor.CallBackProvider<QueuedChu
             queuedChunk.provider.chunkGenerator.recreateStructures(chunk, queuedChunk.x, queuedChunk.z);
         }
 
-        chunk.loadNearby(queuedChunk.provider, queuedChunk.provider.chunkGenerator, false);
+            if(!ReaperConfig.preventChunksWorldBorder || (chunk.locX <= 1875000 && chunk.locZ <= 1875000 && chunk.locX >= -1875000 && chunk.locZ >= -1875000)){ // Papaya - Patch retarded lag exploit at world border
+                chunk.loadNearby(queuedChunk.provider, queuedChunk.provider.chunkGenerator, false);
+            }
         } // Paper
     }
 
