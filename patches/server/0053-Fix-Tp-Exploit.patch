From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: SoftikLord <dimap9986@gmail.com>
Date: Thu, 16 Mar 2023 22:56:51 +0500
Subject: [PATCH] Fix-Tp-Exploit


diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index 645c8fbac91b40d4d31cb4146161e4f658585330..b420367be57a93663bcb699a4a59793dda26b8c8 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -1629,6 +1629,14 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
         return getBukkitEntity().getScoreboard().getHandle();
     }
 
+    @Override
+    public void setPositionRotation(double d0, double d1, double d2, float f, float f1) {
+        super.setPositionRotation(d0, d1, d2, f, f1);
+        if (this.playerConnection != null) {
+            this.playerConnection.resetLastPositionRotation();
+        }
+    }
+
     public void reset() {
         float exp = 0;
         boolean keepInventory = this.world.getGameRules().getBoolean("keepInventory");
diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 8aa4bf6f90714cd8ee5b4a23cd3212aa8857b83a..07d8a84b706cb3ca2c5f153fadec781a7bc6c6ac 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -141,6 +141,16 @@ public class PlayerConnection implements PacketListenerPlayIn, ITickable {
     private final static HashSet<Integer> invalidItems = new HashSet<Integer>(java.util.Arrays.asList(8, 9, 10, 11, 26, 34, 36, 43, 51, 55, 59, 62, 63, 64, 68, 71, 74, 75, 83, 90, 92, 93, 94, 104, 105, 115, 117, 118, 119, 125, 127, 132, 140, 141, 142, 144)); // TODO: Check after every update.
     // CraftBukkit end
 
+    public void resetLastPositionRotation() {
+        lastPosX = Double.MAX_VALUE;
+        lastPosY = Double.MAX_VALUE;
+        lastPosZ = Double.MAX_VALUE;
+        lastPitch = Float.MAX_VALUE;
+        lastYaw = Float.MAX_VALUE;
+
+        PlayerConnection.LOGGER.debug("{} resetLastPositionRotation!", this.player.getName());
+    }
+
     public void e() {
         this.syncPosition();
         this.player.playerTick();
